"""
ë³´ì•ˆ ê¶Œê³ ì‚¬í•­ ìƒì„± ì—”ì§„ (ê°œì¸ì •ë³´ë³´í˜¸ë²• ì¤€ìˆ˜)

ë²•ì  ê·¼ê±°ë³„ ê¶Œê³ ì‚¬í•­:
- ê³ ìœ ì‹ë³„ì •ë³´ (ì œ24ì¡°): ì²˜ë¦¬ ì œí•œ, ì•”í˜¸í™” ì˜ë¬´
- ë¯¼ê°ì •ë³´ (ì œ23ì¡°): ì›ì¹™ì  ì²˜ë¦¬ ê¸ˆì§€, ë³„ë„ ë™ì˜
- ê¸ˆìœµì •ë³´ (ì œ34ì¡°ì˜2): ë…¸ì¶œ ê¸ˆì§€
- ì¼ë°˜ê°œì¸ì •ë³´ (ì œ2ì¡°): ê¸°ë³¸ ë³´í˜¸ ì›ì¹™
"""
from typing import List, Dict
from utils.constants import (
    SEVERITY_WEIGHTS, INFO_LEGAL_CATEGORY, 
    UNIQUE_IDENTIFIERS, EXPOSURE_PROHIBITED_INFO
)


class SecurityRecommendationEngine:
    """ë³´ì•ˆ ê¶Œê³ ì‚¬í•­ ìƒì„± ì—”ì§„ (ê°œì¸ì •ë³´ë³´í˜¸ë²• ê¸°ë°˜)"""
    
    def __init__(self):
        # ìœ„í—˜ë„ ë ˆë²¨ë³„ ê¸°ë³¸ ê¶Œê³ ì‚¬í•­
        self.base_recommendations = {
            "ì‹¬ê°": [
                "ğŸš¨ ì¦‰ì‹œ ë¬¸ì„œ ì ‘ê·¼ ê¶Œí•œì„ ì œí•œí•˜ê³  ì•”í˜¸í™”ë¥¼ ì ìš©í•˜ì„¸ìš”",
                "ğŸ“‹ ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ì(CPO) ë° ë²•ë¬´íŒ€ì— ì¦‰ì‹œ ë³´ê³ í•˜ì„¸ìš”",
                "ğŸ” ë¬¸ì„œ ì•”í˜¸í™” ë° DLP ì†”ë£¨ì…˜ ì ìš©ì„ ê²€í† í•˜ì„¸ìš”",
                "ğŸ“ ê°œì¸ì •ë³´ ì²˜ë¦¬ ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ê³  ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”",
                "âš–ï¸ ê°œì¸ì •ë³´ë³´í˜¸ë²• ìœ„ë°˜ ì—¬ë¶€ë¥¼ ì¦‰ì‹œ ê²€í† í•˜ì„¸ìš”"
            ],
            "ë†’ìŒ": [
                "ğŸ”’ ë¬¸ì„œ ì ‘ê·¼ ê¶Œí•œì„ ì œí•œí•˜ê³  ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹ì„ ì ìš©í•˜ì„¸ìš”",
                "ğŸ—‘ï¸ ë¯¼ê°ì •ë³´ ë³´ê´€ í•„ìš”ì„±ì„ ì¬ê²€í† í•˜ê³  ë¶ˆí•„ìš” ì‹œ ì‚­ì œí•˜ì„¸ìš”",
                "ğŸ’¾ ì•”í˜¸í™”ëœ ì €ì¥ì†Œë¡œ ì´ë™í•˜ê±°ë‚˜ ì ‘ê·¼ í†µì œë¥¼ ê°•í™”í•˜ì„¸ìš”",
                "ğŸ‘¥ ë¬¸ì„œ ì—´ëŒ ëŒ€ìƒìë¥¼ ìµœì†Œí™”í•˜ì„¸ìš”"
            ],
            "ë³´í†µ": [
                "ğŸ“Œ ë¯¼ê°ì •ë³´ê°€ í¬í•¨ëœ ë¬¸ì„œì„ì„ ì¸ì§€í•˜ê³  ì£¼ì˜í•´ì„œ ê´€ë¦¬í•˜ì„¸ìš”",
                "ğŸ” ì •ê¸°ì ìœ¼ë¡œ ë¬¸ì„œ ë³´ì•ˆ ìƒíƒœë¥¼ ì ê²€í•˜ì„¸ìš”",
                "ğŸ“§ ì´ë©”ì¼ ì „ì†¡ ì‹œ ì•”í˜¸í™” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ë¥¼ ì ìš©í•˜ì„¸ìš”",
                "ğŸ”‘ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìë§Œ ì—´ëŒí•˜ë„ë¡ ì„¤ì •í•˜ì„¸ìš”"
            ],
            "ë‚®ìŒ": [
                "âœ… ì¼ë°˜ì ì¸ ë³´ì•ˆ ìˆ˜ì¹™ì„ ì¤€ìˆ˜í•˜ì„¸ìš”",
                "ğŸ“¤ ë¬¸ì„œ ê³µìœ  ì‹œ ìˆ˜ì‹ ìë¥¼ í™•ì¸í•˜ì„¸ìš”",
                "ğŸ§¹ ë¶ˆí•„ìš”í•œ ê°œì¸ì •ë³´ëŠ” ì‚­ì œë¥¼ ê³ ë ¤í•˜ì„¸ìš”"
            ]
        }
        
        # ë²•ì  ë¶„ë¥˜ë³„ ê¶Œê³ ì‚¬í•­
        self.legal_recommendations = {
            "ê³ ìœ ì‹ë³„ì •ë³´": {
                "description": "ì œ24ì¡° ìœ„ë°˜ ê°€ëŠ¥ì„±",
                "recommendations": [
                    "âš ï¸ ê³ ìœ ì‹ë³„ì •ë³´(ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ë“±)ëŠ” ë²•ë ¹ì— ê·¼ê±°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì²˜ë¦¬ ê°€ëŠ¥",
                    "ğŸ” ì•”í˜¸í™” ì €ì¥ ì˜ë¬´: ê³ ìœ ì‹ë³„ì •ë³´ëŠ” ë°˜ë“œì‹œ ì•”í˜¸í™”í•˜ì—¬ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤",
                    "ğŸ“ ë³„ë„ ë™ì˜ í•„ìš”: ë‹¤ë¥¸ ê°œì¸ì •ë³´ì™€ ë³„ë„ë¡œ ë™ì˜ë¥¼ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤",
                    "ğŸ—‘ï¸ ë¶ˆí•„ìš” ì‹œ ì¦‰ì‹œ íŒŒê¸°: ìˆ˜ì§‘ ëª©ì  ë‹¬ì„± í›„ ì§€ì²´ì—†ì´ íŒŒê¸°í•´ì•¼ í•©ë‹ˆë‹¤"
                ]
            },
            "ë¯¼ê°ì •ë³´": {
                "description": "ì œ23ì¡° ìœ„ë°˜ ê°€ëŠ¥ì„±",
                "recommendations": [
                    "ğŸš« ë¯¼ê°ì •ë³´ëŠ” ì›ì¹™ì ìœ¼ë¡œ ì²˜ë¦¬ê°€ ê¸ˆì§€ë©ë‹ˆë‹¤",
                    "ğŸ“‹ ë³„ë„ ë™ì˜ í•„ìˆ˜: ì •ë³´ì£¼ì²´ì˜ ë³„ë„ ëª…ì‹œì  ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤",
                    "âš–ï¸ ë²•ë ¹ìƒ ê·¼ê±° í™•ì¸: ë²•ë ¹ì—ì„œ ì²˜ë¦¬ë¥¼ ìš”êµ¬/í—ˆìš©í•˜ëŠ” ê²½ìš°ì—ë§Œ ê°€ëŠ¥",
                    "ğŸ”’ ì•ˆì „ì¡°ì¹˜ ê°•í™”: ë¶„ì‹¤Â·ë„ë‚œÂ·ìœ ì¶œÂ·ë³€ì¡° ë°©ì§€ ì¡°ì¹˜ë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤"
                ]
            },
            "ê¸ˆìœµì •ë³´": {
                "description": "ì œ34ì¡°ì˜2 ìœ„ë°˜ ê°€ëŠ¥ì„±",
                "recommendations": [
                    "ğŸš¨ ê¸ˆìœµì •ë³´(ê³„ì¢Œë²ˆí˜¸, ì¹´ë“œë²ˆí˜¸)ëŠ” ì •ë³´í†µì‹ ë§ ë…¸ì¶œì´ ê¸ˆì§€ë©ë‹ˆë‹¤",
                    "ğŸ” ì „ì†¡ ì‹œ ì•”í˜¸í™”: PCI-DSS ê¸°ì¤€ì— ë”°ë¼ ì•”í˜¸í™” ì „ì†¡ í•„ìˆ˜",
                    "ğŸ’¾ ì €ì¥ ì‹œ ì•”í˜¸í™”: ë°ì´í„°ë² ì´ìŠ¤ ì•”í˜¸í™” ë° ì ‘ê·¼ í†µì œ í•„ìš”",
                    "ğŸ•µï¸ ì£¼ê¸°ì  ì ê²€: ì™¸ë¶€ ë…¸ì¶œ ì—¬ë¶€ë¥¼ ì •ê¸°ì ìœ¼ë¡œ ì ê²€í•˜ì„¸ìš”"
                ]
            },
            "ì¼ë°˜ê°œì¸ì •ë³´": {
                "description": "ì œ2ì¡° ê¸°ë³¸ ì›ì¹™",
                "recommendations": [
                    "ğŸ“‹ ìˆ˜ì§‘ ëª©ì  ë²”ìœ„ ë‚´ ì²˜ë¦¬: ëª…ì‹œëœ ëª©ì  ì™¸ ì‚¬ìš© ê¸ˆì§€",
                    "ğŸ”‘ ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬: í•„ìš”í•œ ë‹´ë‹¹ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •",
                    "ğŸ“ ì²˜ë¦¬ ê¸°ë¡ ìœ ì§€: ê°œì¸ì •ë³´ ì²˜ë¦¬ ë‚´ì—­ì„ ê¸°ë¡í•˜ì„¸ìš”",
                    "ğŸ—‘ï¸ ë³´ìœ ê¸°ê°„ ì¤€ìˆ˜: ë³´ìœ ê¸°ê°„ ê²½ê³¼ ì‹œ ì§€ì²´ì—†ì´ íŒŒê¸°"
                ]
            }
        }
    
    def generate_recommendations(
        self, 
        detected_items: List[Dict], 
        risk_level: str, 
        risk_score: int,
        document_text: str = ""
    ) -> List[str]:
        """
        ê°œì¸ì •ë³´ë³´í˜¸ë²• ê¸°ë°˜ ë³´ì•ˆ ê¶Œê³ ì‚¬í•­ ìƒì„±
        
        Args:
            detected_items: íƒì§€ëœ í•­ëª© ë¦¬ìŠ¤íŠ¸
            risk_level: ìœ„í—˜ë„ ë ˆë²¨
            risk_score: ìœ„í—˜ë„ ì ìˆ˜
            document_text: ë¬¸ì„œ í…ìŠ¤íŠ¸
            
        Returns:
            ê¶Œê³ ì‚¬í•­ ë¦¬ìŠ¤íŠ¸
        """
        recommendations = []
        
        # 1. ê¸°ë³¸ ê¶Œê³ ì‚¬í•­ (ìœ„í—˜ë„ ë ˆë²¨ ê¸°ë°˜)
        base_recs = self.base_recommendations.get(risk_level, [])
        recommendations.extend(base_recs[:2])
        
        # 2. ë²•ì  ë¶„ë¥˜ë³„ ì§‘ê³„
        category_counts = {
            "ê³ ìœ ì‹ë³„ì •ë³´": 0,
            "ë¯¼ê°ì •ë³´": 0,
            "ê¸ˆìœµì •ë³´": 0,
            "ì¼ë°˜ê°œì¸ì •ë³´": 0
        }
        
        type_counts = {}
        for item in detected_items:
            info_type = item.get('type', '')
            legal_cat = item.get('legal_category', INFO_LEGAL_CATEGORY.get(info_type, 'ì¼ë°˜ê°œì¸ì •ë³´'))
            
            category_counts[legal_cat] = category_counts.get(legal_cat, 0) + 1
            type_counts[info_type] = type_counts.get(info_type, 0) + 1
        
        # 3. ê³ ìœ ì‹ë³„ì •ë³´ ê¶Œê³ ì‚¬í•­ (ì œ24ì¡°)
        unique_id_count = category_counts.get("ê³ ìœ ì‹ë³„ì •ë³´", 0)
        if unique_id_count > 0:
            if unique_id_count >= 10:
                recommendations.append(
                    f"ğŸ”´ [ì œ24ì¡° ìœ„ë°˜ ìš°ë ¤] ëŒ€ëŸ‰ì˜ ê³ ìœ ì‹ë³„ì •ë³´({unique_id_count}ê°œ) íƒì§€: "
                    "ì¦‰ì‹œ ë²•ë¬´íŒ€ ê²€í†  ë° ì•”í˜¸í™” ì¡°ì¹˜ í•„ìš”"
                )
            elif unique_id_count >= 5:
                recommendations.append(
                    f"ğŸ”´ [ì œ24ì¡°] ë‹¤ìˆ˜ì˜ ê³ ìœ ì‹ë³„ì •ë³´({unique_id_count}ê°œ) ë°œê²¬: "
                    "ì•”í˜¸í™” ì €ì¥ ë° ì ‘ê·¼ê¶Œí•œ ìµœì†Œí™” í•„ìš”"
                )
            else:
                recommendations.append(
                    f"ğŸ”´ [ì œ24ì¡°] ê³ ìœ ì‹ë³„ì •ë³´({unique_id_count}ê°œ) í¬í•¨: "
                    "ì²˜ë¦¬ ê·¼ê±° í™•ì¸ ë° ì•”í˜¸í™” ì €ì¥ ê¶Œì¥"
                )
            
            # ê³ ìœ ì‹ë³„ì •ë³´ ì„¸ë¶€ ê¶Œê³ 
            recommendations.append(self.legal_recommendations["ê³ ìœ ì‹ë³„ì •ë³´"]["recommendations"][1])
        
        # 4. ë¯¼ê°ì •ë³´ ê¶Œê³ ì‚¬í•­ (ì œ23ì¡°)
        sensitive_count = category_counts.get("ë¯¼ê°ì •ë³´", 0)
        if sensitive_count > 0:
            if sensitive_count >= 10:
                recommendations.append(
                    f"ğŸŸ  [ì œ23ì¡° ìœ„ë°˜ ìš°ë ¤] ëŒ€ëŸ‰ì˜ ë¯¼ê°ì •ë³´({sensitive_count}ê°œ) íƒì§€: "
                    "ì²˜ë¦¬ ê·¼ê±° ë° ë™ì˜ ì—¬ë¶€ ì¦‰ì‹œ í™•ì¸ í•„ìš”"
                )
            elif sensitive_count >= 5:
                recommendations.append(
                    f"ğŸŸ  [ì œ23ì¡°] ë‹¤ìˆ˜ì˜ ë¯¼ê°ì •ë³´({sensitive_count}ê°œ) ë°œê²¬: "
                    "ì •ë³´ì£¼ì²´ ë³„ë„ ë™ì˜ í™•ì¸ ë° ì•ˆì „ì¡°ì¹˜ ê°•í™”"
                )
            else:
                recommendations.append(
                    f"ğŸŸ  [ì œ23ì¡°] ë¯¼ê°ì •ë³´({sensitive_count}ê°œ) í¬í•¨: "
                    "ì²˜ë¦¬ ê·¼ê±° í™•ì¸ ê¶Œì¥"
                )
        
        # 5. ê¸ˆìœµì •ë³´ ê¶Œê³ ì‚¬í•­ (ì œ34ì¡°ì˜2)
        financial_count = category_counts.get("ê¸ˆìœµì •ë³´", 0)
        if financial_count > 0:
            if financial_count >= 10:
                recommendations.append(
                    f"ğŸŸ£ [ì œ34ì¡°ì˜2 ìœ„ë°˜ ìš°ë ¤] ëŒ€ëŸ‰ì˜ ê¸ˆìœµì •ë³´({financial_count}ê°œ) íƒì§€: "
                    "ì¦‰ì‹œ ë…¸ì¶œ ì°¨ë‹¨ ë° ì•”í˜¸í™” ì¡°ì¹˜ í•„ìš”"
                )
            elif financial_count >= 5:
                recommendations.append(
                    f"ğŸŸ£ [ì œ34ì¡°ì˜2] ë‹¤ìˆ˜ì˜ ê¸ˆìœµì •ë³´({financial_count}ê°œ) ë°œê²¬: "
                    "ì •ë³´í†µì‹ ë§ ë…¸ì¶œ ì—¬ë¶€ ì ê²€ ë° ì•”í˜¸í™” í•„ìš”"
                )
            else:
                recommendations.append(
                    f"ğŸŸ£ [ì œ34ì¡°ì˜2] ê¸ˆìœµì •ë³´({financial_count}ê°œ) í¬í•¨: "
                    "PCI-DSS ê¸°ì¤€ ì•”í˜¸í™” ì €ì¥/ì „ì†¡ ê¶Œì¥"
                )
        
        # 6. ì¼ë°˜ê°œì¸ì •ë³´ ê¶Œê³ ì‚¬í•­ (ì œ2ì¡°)
        general_count = category_counts.get("ì¼ë°˜ê°œì¸ì •ë³´", 0)
        if general_count >= 20:
            recommendations.append(
                f"ğŸ”µ [ì œ2ì¡°] ëŒ€ëŸ‰ì˜ ì¼ë°˜ê°œì¸ì •ë³´({general_count}ê°œ) ë°œê²¬: "
                "ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ í™•ì¸ ë° ì ‘ê·¼ê¶Œí•œ ê´€ë¦¬ ê°•í™” í•„ìš”"
            )
        elif general_count >= 10:
            recommendations.append(
                f"ğŸ”µ [ì œ2ì¡°] ë‹¤ìˆ˜ì˜ ì¼ë°˜ê°œì¸ì •ë³´({general_count}ê°œ) í¬í•¨: "
                "ì²˜ë¦¬ ëª©ì  ë²”ìœ„ ë‚´ ì´ìš© ì—¬ë¶€ í™•ì¸ ê¶Œì¥"
            )
        
        # 7. ë³µí•© ë…¸ì¶œ ê¶Œê³ ì‚¬í•­
        active_categories = sum(1 for c in category_counts.values() if c > 0)
        if active_categories >= 3:
            recommendations.append(
                f"âš ï¸ [ë³µí•© ìœ„í—˜] {active_categories}ê°€ì§€ ë²•ì  ë¶„ë¥˜ì˜ ê°œì¸ì •ë³´ í˜¼ì¬: "
                "í†µí•© ë³´ì•ˆ ê´€ë¦¬ ì²´ê³„ ìˆ˜ë¦½ ë° ì¢…í•© ë³´ì•ˆ ì ê²€ í•„ìš”"
            )
        elif active_categories >= 2:
            high_risk_cats = [k for k, v in category_counts.items() 
                           if v > 0 and k in ["ê³ ìœ ì‹ë³„ì •ë³´", "ë¯¼ê°ì •ë³´", "ê¸ˆìœµì •ë³´"]]
            if len(high_risk_cats) >= 2:
                recommendations.append(
                    f"âš ï¸ [ë³µí•© ìœ„í—˜] ê³ ìœ„í—˜ ì •ë³´ ë³µí•© ë…¸ì¶œ({', '.join(high_risk_cats)}): "
                    "ìš°ì„ ìˆœìœ„ ë†’ì€ ë³´ì•ˆ ì¡°ì¹˜ í•„ìš”"
                )
        
        # 8. ìœ„í—˜ë„ ì ìˆ˜ë³„ ê¸´ê¸‰ ì¡°ì¹˜
        if risk_score >= 90:
            recommendations.append(
                "ğŸš¨ [ê¸´ê¸‰] ìµœê³  ìœ„í—˜ë„: ì¦‰ì‹œ ë¬¸ì„œ ê²©ë¦¬ ë° ë³´ì•ˆíŒ€ ì—ìŠ¤ì»¬ë ˆì´ì…˜ í•„ìš”"
            )
        elif risk_score >= 75:
            recommendations.append(
                "â° [ê¸´ê¸‰] ê³ ìœ„í—˜ ë¬¸ì„œ: 24ì‹œê°„ ë‚´ ë³´ì•ˆ ì¡°ì¹˜ ì™„ë£Œ ê¶Œì¥"
            )
        
        # 9. ê¶Œì¥ ì¡°ì¹˜ ìš”ì•½
        if risk_score >= 50:
            recommendations.append(
                "ğŸ“‹ [ê¶Œì¥ ì¡°ì¹˜] 1.ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹ 2.ì ‘ê·¼ê¶Œí•œ ì¬ì„¤ì • "
                "3.ì•”í˜¸í™” ì ìš© 4.ê°ì‚¬ë¡œê·¸ í™œì„±í™” 5.ë³´ìœ ê¸°ê°„ ì ê²€"
            )
        
        # 10. ì¤‘ë³µ ì œê±° ë° ìµœëŒ€ ê°œìˆ˜ ì œí•œ
        recommendations = list(dict.fromkeys(recommendations))
        
        return recommendations[:10]
    
    def generate_legal_summary(self, detected_items: List[Dict]) -> str:
        """ë²•ì  ë¶„ë¥˜ë³„ ìš”ì•½ ë¬¸ìì—´ ìƒì„±"""
        category_counts = {}
        
        for item in detected_items:
            legal_cat = item.get('legal_category', 'ì¼ë°˜ê°œì¸ì •ë³´')
            category_counts[legal_cat] = category_counts.get(legal_cat, 0) + 1
        
        summary_parts = []
        
        if category_counts.get("ê³ ìœ ì‹ë³„ì •ë³´", 0) > 0:
            summary_parts.append(
                f"ê³ ìœ ì‹ë³„ì •ë³´(ì œ24ì¡°): {category_counts['ê³ ìœ ì‹ë³„ì •ë³´']}ê°œ"
            )
        if category_counts.get("ë¯¼ê°ì •ë³´", 0) > 0:
            summary_parts.append(
                f"ë¯¼ê°ì •ë³´(ì œ23ì¡°): {category_counts['ë¯¼ê°ì •ë³´']}ê°œ"
            )
        if category_counts.get("ê¸ˆìœµì •ë³´", 0) > 0:
            summary_parts.append(
                f"ê¸ˆìœµì •ë³´(ì œ34ì¡°ì˜2): {category_counts['ê¸ˆìœµì •ë³´']}ê°œ"
            )
        if category_counts.get("ì¼ë°˜ê°œì¸ì •ë³´", 0) > 0:
            summary_parts.append(
                f"ì¼ë°˜ê°œì¸ì •ë³´(ì œ2ì¡°): {category_counts['ì¼ë°˜ê°œì¸ì •ë³´']}ê°œ"
            )
        
        if summary_parts:
            return "íƒì§€ëœ ê°œì¸ì •ë³´ ë²•ì  ë¶„ë¥˜: " + ", ".join(summary_parts)
        return "íƒì§€ëœ ê°œì¸ì •ë³´ ì—†ìŒ"
